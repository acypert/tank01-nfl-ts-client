# Implementation Plan: Tank01 NFL API Refactor - Flat Interface

**Branch**: `002-api-refactor-flat-interface` | **Date**: 2025-11-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-api-refactor-flat-interface/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the Constitution-based workflow.

## Summary

Refactor Tank01 NFL Client from nested client architecture (`client.teams.getTeams()`) to flat interface (`client.getNFLTeams()`) while maintaining internal feature-folder organization. Fix all endpoint parameters to match actual Tank01 API documentation, remove 7 non-existent endpoints, and add 10 missing endpoints. All new and updated endpoints will have full zod schema validation, strict OR parameter validation, comprehensive JSDoc documentation, and minimal contract tests (respecting 1,000 API requests/month quota). This is a breaking change from v0.1.0 to v0.2.0 with no backward compatibility layer.

**Technical Approach**: Keep existing feature folders (teams/, players/, games/, live/, stats/) but refactor Tank01Client class to directly expose all ~30 methods instead of nested sub-clients. Add new feature folders (odds/, news/, fantasy/, info/) for missing endpoints. Update all method signatures with correct Tank01 API parameters, add client-side validation for OR constraints (e.g., playerName OR playerID), and ensure all responses validate against zod schemas.

## Technical Context

**Language/Version**: TypeScript 5.3.3 (strict mode enabled, exactOptionalPropertyTypes, verbatimModuleSyntax)
**Primary Dependencies**: node-fetch v3.3.2, zod v3.22.4 (runtime validation)
**Storage**: N/A (API client library)
**Testing**: vitest (existing), contract tests against live Tank01 API
**Target Platform**: Node.js 18+ (LTS)
**Project Type**: Single TypeScript library (feature-folder organized)
**Performance Goals**: <100ms per API call overhead, connection reuse via keep-alive
**Constraints**: Type-safe API, dual export (CJS + ESM via tsup), 80%+ test coverage, <100 API requests per contract test run
**Scale/Scope**: ~30 Tank01 NFL API endpoints, published npm package (@tank01/nfl-client)

### Known Complexities

1. **OR Parameters**: playerName OR playerID, teamID OR teamAbv, gameDate OR gameID require runtime validation
2. **Parameter Interdependencies**: fantasyPoints requires getStats=true, various parameters override each other
3. **API Quota Constraint**: 1,000 requests/month limits contract test coverage strategy
4. **Breaking Changes**: v0.1.0 → v0.2.0 removes nested clients with no deprecation period

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### Type Safety First

- [x] All new code uses TypeScript strict mode (no `any` types without justification)
- [x] All API responses have corresponding TypeScript interfaces
- [x] Function signatures are fully typed (parameters + return values)
- [x] Type guards used for runtime type narrowing where needed (OR parameter validation)

**Status**: ✅ PASS - Existing codebase already TypeScript strict, refactor maintains this standard

### Feature Folder Organization

- [x] Code organized by feature/resource, not technical layers
- [x] Each feature folder exports public API via `index.ts`
- [x] Shared code appropriately placed in `src/common/` or `src/shared/`

**Status**: ✅ PASS - Existing structure correct (teams/, players/, games/), adding odds/, news/, fantasy/, info/

### Comprehensive Testing

- [x] Unit tests cover all public functions
- [x] Integration tests validate API client with mocked responses
- [x] Contract tests validate response types match schemas (minimal coverage due to quota)
- [x] Error handling paths are tested

**Contract Test Priority** (8 endpoints, ~50 API requests total):

1. `getNFLTeams` - Basic call + with options (rosters, teamStats): 3 requests
2. `getNFLTeamRoster` - teamID + teamAbv OR validation: 2 requests
3. `getNFLPlayerInfo` - playerName + playerID OR validation: 2 requests
4. `getNFLGamesForWeek` - Current week + seasonType parameter: 2 requests
5. `getNFLBoxScore` - Basic + with playByPlay/fantasyPoints: 2 requests
6. `getNFLADP` - halfPPR + PPR adpType: 2 requests
7. `getNFLBettingOdds` - gameDate + gameID OR validation: 2 requests
8. `getNFLProjections` - week + playerID override: 2 requests
9. Additional smoke tests for remaining 22 endpoints: ~35 requests

**Status**: ✅ PASS - Plan includes test updates for all changed methods, minimal contract tests per quota constraint

### API Contract Compliance

- [x] Runtime validation (zod schemas) for all API responses
- [x] Type definitions derived from or validated against schemas
- [x] Failed validations throw descriptive errors
- [x] API version compatibility documented

**Status**: ✅ PASS - All endpoints will have zod schemas, existing pattern maintained

### Developer Experience

- [x] TSDoc comments on all public APIs with examples
- [x] Error messages are actionable (OR validation errors specify requirements)
- [x] Configuration has sensible defaults
- [x] Naming is clear and consistent (getNFLTeams, getNFLPlayerInfo, etc.)
- [x] README includes migration guide v0.1.0 → v0.2.0

**Status**: ✅ PASS - Comprehensive JSDoc required, migration guide in scope

### Technical Standards

- [x] Builds without TypeScript errors
- [x] Passes ESLint with zero warnings
- [x] Code formatted with Prettier
- [x] Generates `.d.ts` type definition files
- [x] 80%+ test coverage achieved

**Status**: ✅ PASS - Existing build infrastructure maintained, coverage enforced

## Phase 0: Research & Planning

**Goal**: Resolve all "NEEDS CLARIFICATION" items and document research findings.

### Research Tasks

All clarifications have been completed in the spec.md file during the clarification phase:

1. ✅ **Migration Strategy**: Hard break with no deprecation warnings (v0.1.0 → v0.2.0)
2. ✅ **Response Validation**: Full zod schemas for all endpoints (consistent with existing pattern)
3. ✅ **Parameter Validation**: Strict validation - throw TypeError for OR constraint violations
4. ✅ **Testing Strategy**: Contract tests against live API, minimal coverage (<100 requests per run)
5. ✅ **Documentation Level**: Comprehensive JSDoc with descriptions, valid values, examples

### Research Output: research.md

**Decision**: No additional research phase needed - all ambiguities resolved during spec clarification.

**Rationale**: The clarification session answered all high-impact questions. Implementation details are clear:

- Architecture pattern: Flat interface with feature folders
- Parameter validation: Client-side with descriptive TypeErrors
- Testing approach: Minimal contract tests (8-10 critical endpoints)
- Documentation standard: Full JSDoc with examples

## Phase 1: Design & Contracts

### Data Model (Inline - No separate file needed)

#### Endpoint Organization by Feature

**Teams** (src/teams/):

- getNFLTeams: List all teams with optional enrichment (rosters, schedules, stats, standings)
- getNFLTeamRoster: Get team roster (requires teamID OR teamAbv)
- getNFLTeamSchedule: Get team schedule (requires teamID OR teamAbv)
- getNFLDepthCharts: Get depth charts for all teams (NEW)

**Players** (src/players/):

- getNFLPlayerList: Get all players (4,500+ records)
- getNFLPlayerInfo: Get player info (requires playerName OR playerID)
- getNFLGamesForPlayer: Get player game log (NEW)

**Games** (src/games/):

- getNFLGamesForWeek: Get games for a week (requires week, optional seasonType/season)
- getNFLGameInfo: Get game details (requires gameID)
- getNFLTeamSchedule: Team-specific schedule
- getNFLScoresOnly: Quick score access (NEW)
- getNFLGamesForDate: Games by date (NEW)

**Live** (src/live/):

- getNFLBoxScore: Get box score with optional play-by-play and fantasy points

**Fantasy** (src/fantasy/ - NEW FOLDER):

- getNFLADP: Average draft position (requires adpType)
- getNFLProjections: Fantasy projections (weekly or seasonal)
- getNFLDFS: Daily fantasy sports data (requires date)

**Odds** (src/odds/ - NEW FOLDER):

- getNFLBettingOdds: Betting lines (requires gameDate OR gameID)

**News** (src/news/ - NEW FOLDER):

- getNFLNews: NFL news feed with filtering options

**Info** (src/info/ - NEW FOLDER):

- getNFLCurrentInfo: Current NFL season/week information

#### Parameter Validation Strategy

**OR Constraints** (require exactly one):

- playerName OR playerID → validateOneOf()
- teamID OR teamAbv → validateOneOf()
- gameDate OR gameID → validateOneOf()

**Dependencies**:

- fantasyPoints=true requires getStats=true
- Various parameters override each other (documented in JSDoc)

### API Contracts (Generated in Phase 1)

**Output**: `contracts/` directory structure:

```
contracts/
├── teams/
│   ├── getNFLTeams.schema.ts
│   ├── getNFLTeamRoster.schema.ts
│   └── getNFLDepthCharts.schema.ts
├── players/
│   ├── getNFLPlayerInfo.schema.ts
│   └── getNFLGamesForPlayer.schema.ts
├── games/
│   ├── getNFLGamesForWeek.schema.ts
│   ├── getNFLScoresOnly.schema.ts
│   └── getNFLGamesForDate.schema.ts
├── fantasy/
│   ├── getNFLADP.schema.ts
│   ├── getNFLProjections.schema.ts
│   └── getNFLDFS.schema.ts
├── odds/
│   └── getNFLBettingOdds.schema.ts
├── news/
│   └── getNFLNews.schema.ts
└── info/
    └── getNFLCurrentInfo.schema.ts
```

Each schema file exports:

1. Request parameter zod schema
2. Response zod schema
3. TypeScript types inferred from schemas

### Quickstart Guide (Inline)

```markdown
# Tank01 NFL Client v0.2.0 - Quickstart

## Installation

\`\`\`bash
npm install @tank01/nfl-client
\`\`\`

## Basic Usage

\`\`\`typescript
import { Tank01Client } from '@tank01/nfl-client';

const client = new Tank01Client({
apiKey: process.env.TANK01_API_KEY,
});

// Get all teams with rosters
const teams = await client.getNFLTeams({ rosters: true });

// Get player info (either playerName OR playerID)
const purdy = await client.getNFLPlayerInfo({
playerName: 'brock_purdy',
getStats: true,
});

// Get week 1 games
const games = await client.getNFLGamesForWeek({
week: '1',
season: 2024,
seasonType: 'reg',
});

// Get betting odds
const odds = await client.getNFLBettingOdds({
gameDate: '20241215',
});
\`\`\`

## Migration from v0.1.0

**BREAKING CHANGE**: Nested clients removed.

### Before (v0.1.0)

\`\`\`typescript
const teams = await client.teams.getTeams();
const player = await client.players.getPlayer('4381786');
\`\`\`

### After (v0.2.0)

\`\`\`typescript
const teams = await client.getNFLTeams();
const player = await client.getNFLPlayerInfo({ playerID: 4381786 });
\`\`\`
```

## Phase 2: Implementation (Generated by /speckit.tasks)

**Note**: Detailed task breakdown will be generated by the `/speckit.tasks` command.

### High-Level Implementation Categories

1. **Refactor Tank01Client** (Breaking Change)
   - Remove nested client properties
   - Add ~30 methods directly to Tank01Client class
   - Maintain delegation to feature folders

2. **Update Existing Endpoints** (Parameter Fixes)
   - Fix parameters for 9 existing endpoints
   - Add OR parameter validation

3. **Remove Fake Endpoints** (Breaking Change)
   - Delete 7 non-existent endpoints
   - Update exports

4. **Add Missing Endpoints** (New Features)
   - Add 10 new endpoints across 4 new feature folders

5. **Documentation & Tests**
   - Add comprehensive JSDoc
   - Update all tests
   - Create minimal contract tests
   - Update migration guide

## Project Structure

### Documentation (this feature)

```text
specs/002-api-refactor-flat-interface/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (/speckit.plan output)
├── contracts/           # Schema files (to be generated in Phase 1)
└── tasks.md             # Phase 2 output (generated by /speckit.tasks command)
```

Note: research.md and data-model.md are inline in this plan (not separate files) since all clarifications were completed during spec phase.

### Source Code (repository root)

```text
src/
├── client.ts                 # REFACTORED - flat interface with ~30 methods
│
├── teams/                    # UPDATED - fix params, add getNFLDepthCharts
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLTeams.ts       # UPDATED params (sortBy, rosters, etc.)
│   ├── getNFLTeamRoster.ts  # UPDATED params (OR validation)
│   ├── getNFLTeamSchedule.ts
│   ├── getNFLDepthCharts.ts  # NEW endpoint
│   └── __tests__/
│
├── players/                  # UPDATED - fix params, remove fake, add endpoints
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLPlayerList.ts  # NO CHANGE
│   ├── getNFLPlayerInfo.ts  # UPDATED params (OR validation)
│   ├── getNFLGamesForPlayer.ts # NEW endpoint
│   └── __tests__/
│
├── games/                    # UPDATED - fix params, add endpoints
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLGamesForWeek.ts # UPDATED params
│   ├── getNFLGameInfo.ts
│   ├── getNFLTeamSchedule.ts
│   ├── getNFLScoresOnly.ts   # NEW endpoint
│   ├── getNFLGamesForDate.ts # NEW endpoint
│   └── __tests__/
│
├── live/                     # UPDATED - remove fakes, fix params
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLBoxScore.ts    # UPDATED params
│   └── __tests__/
│
├── fantasy/                  # NEW folder
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLADP.ts
│   ├── getNFLProjections.ts
│   ├── getNFLDFS.ts
│   └── __tests__/
│
├── odds/                     # NEW folder
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLBettingOdds.ts
│   └── __tests__/
│
├── news/                     # NEW folder
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLNews.ts
│   └── __tests__/
│
├── info/                     # NEW folder
│   ├── index.ts
│   ├── types.ts
│   ├── schemas.ts
│   ├── getNFLCurrentInfo.ts
│   └── __tests__/
│
├── common/                   # UPDATED - add validation helpers
│   ├── http/
│   ├── errors/
│   ├── config/
│   ├── validation/          # NEW - parameter validation
│   │   ├── parameters.ts
│   │   └── __tests__/
│   └── utils/
│
├── types/
└── index.ts                 # UPDATED - export flat interface

tests/contract/              # NEW - minimal live API tests
├── teams.contract.test.ts
├── players.contract.test.ts
├── games.contract.test.ts
└── README.md                # Document quota limits

examples/                     # UPDATED - all use flat interface
├── get-teams.ts
├── get-player.ts
└── ...

README.md                     # UPDATED - migration guide
CHANGELOG.md                  # UPDATED - breaking changes
package.json                  # UPDATED - version 0.2.0
```

**Structure Decision**: Maintain feature folder organization per Constitution. Add 4 new folders (fantasy/, odds/, news/, info/). Delete stats/ folder (all fake endpoints). Refactor Tank01Client to expose flat interface while delegating to feature folders.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
| --------- | ---------- | ------------------------------------ |
| None      | -          | -                                    |

**Analysis**: This refactor maintains full Constitution compliance. No violations required:

- Type safety maintained throughout (strict TypeScript)
- Feature folder organization preserved (adding 4 new folders)
- Comprehensive testing maintained (unit + integration + minimal contract)
- API contract compliance maintained (zod schemas for all endpoints)
- Developer experience improved (flat interface, comprehensive JSDoc)
- Technical standards maintained (build, lint, format, coverage)

## Execution Checklist

### Phase 0: Research (Completed)

- [x] All clarifications resolved during spec phase
- [x] No additional research needed

### Phase 1: Design & Contracts

- [x] Data model documented (inline in this plan)
- [x] Contract schemas design documented (will be generated during Phase 2 implementation)
- [x] Quickstart guide documented (inline in this plan)
- [x] Run agent script to update context (completed - copilot-instructions.md updated)
- [x] Constitution compliance verified

### Phase 2: Implementation (Generated by /speckit.tasks)

- [x] Broken down into 205 specific tasks across 15 phases
- [x] Task categories: setup, refactor, update, remove, add, validate, document, test, release
- [x] Parallel execution opportunities documented
- [x] Estimated 24-28 hours over 4 days

### Post-Implementation

- [ ] Verify all Constitution checks pass
- [ ] Run full test suite (npm test)
- [ ] Build package (npm run build)
- [ ] Verify package size increase <20%
- [ ] Contract tests pass with <100 API requests
- [ ] Generate CHANGELOG entry
- [ ] Tag release v0.2.0
- [ ] Publish to npm

## Next Steps

1. **Generate contract schemas** in `contracts/` directory (Phase 1)
2. **Run** `/speckit.tasks` to generate detailed task breakdown (Phase 2)
3. **Begin implementation** following task list

## Notes

**Critical Path**:

1. Refactor Tank01Client class (breaks everything)
2. Update existing endpoint parameters (unblocks testing)
3. Add new endpoints (completes feature set)
4. Add validation & documentation (quality gates)

**Risk Mitigation**:

- Keep feature folders intact during refactor
- Update tests incrementally with code changes
- Use minimal contract tests to respect API quota
- Document breaking changes thoroughly

**API Quota Management**:

- Contract tests limited to 8-10 critical endpoints
- Tests run manually before releases (not in CI)
- Each test run <100 API requests (10% of monthly quota)
